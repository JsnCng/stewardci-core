<!-- TODO: Adjust the 'TODO_*' occurrences with correct values -->
<html lang="en" ng-app="app">

<head>
    <!--
            This dynamic HTML page loads the changelog.yaml from the specified repository
            and renders a more readable, formatted HTML version of it. We recommend to push
            this page to the GitHub pages to make it accessible as HTML.

            This page supports direct links to specific versions by appending '#<version>' to the URL.

            This page supports rendering of specific versions by appending query parameter '?version=<version>' to the URL.
        -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
        integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.2/angular-sanitize.min.js"></script>
    <script>

            const repoUrl = "https://github.com/SAP/stewardci-core";
            //The following URL has to point the the RAW (!) version of the changelog.yaml in the master branch
            const changelogYamlUrl = "https://raw.githubusercontent.com/SAP/stewardci-core/master/changelog.yaml";
            const jiraUrl = "";
            const jiraProjectName = "";


        var app = angular.module('app', []);
        angular.module('app', ['ngSanitize']).controller('MyController', ['$scope', function ($scope) {
            $scope.changelog = [];
            $scope.config = {
                repoUrl: repoUrl,
                changelogYamlUrl: changelogYamlUrl,
                jiraUrl: jiraUrl,
                jiraProjectName: jiraProjectName
            };
            let queryString = window.location.search;
            let urlParams = new URLSearchParams(queryString);
            let versionFilter = urlParams.get("version")
            $scope.filter = {
                version: versionFilter ? versionFilter : ""
            };

            xmlhttp = new XMLHttpRequest();
            xmlhttp.onreadystatechange = function () {
                if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                    let changelog = jsyaml.load(xmlhttp.responseText);
                    for (let ci = 0; ci < (changelog ? changelog.length : 0); ci++) {
                        let release = changelog[ci];
                        release.dateString = release.version == "NEXT" ? "soon" : new Date(release.date).toDateString();
                        release.renderClass = release.version == "NEXT" ? "next" : "release"
                        for (let ri = 0; ri < (release.changes ? release.changes.length : 0); ri++) {
                            let change = release.changes[ri];
                            change.pullRequestNumbers = (typeof change.pullRequestNumber == "number") ? [change.pullRequestNumber] : change.pullRequestNumber;
                            change.jiraIssueNumbers = (typeof change.jiraIssueNumber == "number") ? [change.jiraIssueNumber] : change.jiraIssueNumber;
                            change.descriptionHtml = markdown2Html(change.description);
                            change.warningHtml = markdown2Html(change.warning);
                            change.upgradeNotesHtml = markdown2Html(change.upgradeNotes);
                            change.deprecationsHtml = markdown2Html(change.deprecations);
                        }
                    }
                    $scope.changelog = changelog;
                    $scope.$apply();
                }
            }
            xmlhttp.open("GET", changelogYamlUrl, true);
            xmlhttp.send();
        }]);

        function markdown2Html(markdownText) {
            let mdConverter = new showdown.Converter();
            let html = mdConverter.makeHtml(markdownText);
            return html;
        }
    </script>

    <style>
        .next {
            background-color: lightgoldenrodyellow;
        }
    </style>
</head>

<body ng-controller="MyController">
    <div class="container-md">
        <h1>Changelog</h1>
        <p>
            This generated changelog is based on the <a href="{{config.changelogYamlUrl}}">changelog.yaml</a> in the
            repositories main branch.
            Click here to <a href="?">list all versions</a>.
        </p>
        <div class="jumbotron shadow {{release.renderClass}}" ng-repeat="release in changelog | filter : {version: filter.version}"
            ng-if="release.changes.length > 0">
            <h3 class="display-4" id="{{release.version}}">{{release.version}}</h3>
            <p>Release Date: {{release.dateString}}</p>
            <div>
                <div ng-repeat="change in release.changes">
                    <hr class="my-4">
                    <h4>{{change.title}}</h4>
                    <p class="font-weight-lighter">Type: {{change.type}} / Impact: {{change.impact}}</p>

                    <p ng-bind-html="change.descriptionHtml"></p>

                    <div class="row">
                        <div ng-if="change.warning" class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <span class="badge badge-warning">
                                            <svg width="1.0625em" height="1em" viewBox="0 0 17 16"
                                                class="bi bi-exclamation-triangle" fill="currentColor"
                                                xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd"
                                                    d="M7.938 2.016a.146.146 0 0 0-.054.057L1.027 13.74a.176.176 0 0 0-.002.183c.016.03.037.05.054.06.015.01.034.017.066.017h13.713a.12.12 0 0 0 .066-.017.163.163 0 0 0 .055-.06.176.176 0 0 0-.003-.183L8.12 2.073a.146.146 0 0 0-.054-.057A.13.13 0 0 0 8.002 2a.13.13 0 0 0-.064.016zm1.044-.45a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566z" />
                                                <path
                                                    d="M7.002 12a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 5.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995z" />
                                            </svg></span>
                                        Warning
                                    </h5>
                                    <p class="card-text" ng-bind-html="change.warningHtml"></p>
                                </div>
                            </div>
                        </div>
                        <div ng-if="change.upgradeNotes" class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <span class="badge badge-danger">
                                            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-lightning"
                                                fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                                <path fill-rule="evenodd"
                                                    d="M11.251.068a.5.5 0 0 1 .227.58L9.677 6.5H13a.5.5 0 0 1 .364.843l-8 8.5a.5.5 0 0 1-.842-.49L6.323 9.5H3a.5.5 0 0 1-.364-.843l8-8.5a.5.5 0 0 1 .615-.09zM4.157 8.5H7a.5.5 0 0 1 .478.647L6.11 13.59l5.732-6.09H9a.5.5 0 0 1-.478-.647L9.89 2.41 4.157 8.5z" />
                                            </svg></span>
                                        Upgrade Notes
                                    </h5>
                                    <p class="card-text" ng-bind-html="change.upgradeNotesHtml"></p>
                                </div>
                            </div>
                        </div>
                        <div ng-if="change.deprecations" class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <h5 class="card-title">
                                        <span class="badge badge-info">
                                            <svg width="1em" height="1em" viewBox="0 0 16 16" class="bi bi-trash"
                                                fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                                <path
                                                    d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z" />
                                                <path fill-rule="evenodd"
                                                    d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4L4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z" />
                                            </svg>
                                        </span>
                                        Deprecations
                                    </h5>
                                    <p class="card-text" ng-bind-html="change.deprecationsHtml"></p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <p>
                        <span ng-repeat="prNumber in change.pullRequestNumbers">
                            <span ng-if="$index > 0">, </span>
                            <a href="{{config.repoUrl}}/pull/{{prNumber}}">#{{prNumber}}</a>
                        </span>
                        <span ng-if="change.pullRequestNumber && change.jiraIssueNumber"> | </span>
                        <span ng-repeat="issueNumber in change.jiraIssueNumbers">
                            <span ng-if="$index > 0">, </span>
                            <a href="{{config.jiraUrl}}/browse/{{config.jiraProjectName}}-{{issueNumber}}">{{config.jiraProjectName}}<span
                                    ng-if="config.jiraProjectName">-</span>{{issueNumber}}</a>
                        </span>
                    </p>
                </div>
            </div>
        </div>
    </div>
</body>

</html>
