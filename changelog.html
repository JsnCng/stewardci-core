<!-- TODO: Adjust the 'TODO_*' occurrences with correct values -->
<html lang="en" ng-app="app">
    <head>
        <!--
            This dynamic HTML page loads the changelog.yaml from the specified repository
            and renders a more readable, formatted HTML version of it. We recommend to push
            this page to the GitHub pages to make it accessible as HTML.

            This page supports direct links to specific versions by appending '#<version>' to the URL.

            This page supports rendering of specific versions by appending query parameter '?version=<version>' to the URL.
        -->
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-sanitize/1.8.2/angular-sanitize.min.js"></script>
        <script>

            const repoUrl = "https://github.com/SAP/stewardci-core";
            //The following URL has to point the the RAW (!) version of the changelog.yaml in the master branch
            const changelogYamlUrl = "https://raw.githubusercontent.com/SAP/stewardci-core/master/changelog.yaml";
            const jiraUrl = "";
            const jiraProjectName = "";


            var app = angular.module('app', []);
            angular.module('app', ['ngSanitize']).controller('MyController', ['$scope', function($scope){
                $scope.changelog = [];
                $scope.config = {
                    repoUrl: repoUrl,
                    changelogYamlUrl: changelogYamlUrl,
                    jiraUrl: jiraUrl,
                    jiraProjectName: jiraProjectName
                };
                let queryString = window.location.search;
                let urlParams = new URLSearchParams(queryString);
                let versionFilter = urlParams.get("version")
                $scope.filter = {
                    version: versionFilter ? versionFilter : ""
                };

                xmlhttp=new XMLHttpRequest();
                xmlhttp.onreadystatechange = function()
                {
                    if (xmlhttp.readyState==4 && xmlhttp.status==200)
                    {
                        let changelog = jsyaml.load(xmlhttp.responseText);
                        for(let ci = 0; ci < (changelog ? changelog.length : 0); ci++) {
                            let release = changelog[ci];
                            release.dateString = release.version == "NEXT" ? "soon" : new Date(release.date).toDateString();
                            release.renderClass = release.version == "NEXT" ? "next" : "release"
                            for(let ri = 0; ri < (release.changes ? release.changes.length : 0); ri++) {
                                let change = release.changes[ri];
                                change.pullRequestNumbers = (typeof change.pullRequestNumber == "number") ? [change.pullRequestNumber] : change.pullRequestNumber;
                                change.jiraIssueNumbers = (typeof change.jiraIssueNumber == "number") ? [change.jiraIssueNumber] : change.jiraIssueNumber;
                                change.descriptionHtml = markdown2Html(change.description);
                                change.warningHtml = markdown2Html(change.warning);
                                change.upgradeNotesHtml = markdown2Html(change.upgradeNotes);
                                change.deprecationsHtml = markdown2Html(change.deprecations);
                            }
                        }
                        $scope.changelog = changelog;
                        $scope.$apply();
                    }
                }
                xmlhttp.open("GET", changelogYamlUrl, true);
                xmlhttp.send();
            }]);

            function markdown2Html(markdownText) {
                let mdConverter = new showdown.Converter();
                let html = mdConverter.makeHtml(markdownText);
                return html;
            }
        </script>

        <style>
            body {
                font-family: sans-serif;
            }
            .next {
                background-color: palegoldenrod;
                padding: 5px;
                margin-bottom: 10px;
            }
            .release {
                background-color: LightBlue;
                padding: 5px;
                margin-bottom: 10px;
            }
            .change {
                background-color: #eee;
                padding: 5px;
                margin-bottom: 10px;
            }
            .categorization {
                font-size: 0.9em;
                color: royalblue;
            }
            .version a {
                text-decoration: none;
                color: black;
            }
            .cell {
                vertical-align: top;
                background-color: #fff;
                padding: 3px;
                border-style: none;
                border-width: 1px;
                border-color: lightblue;
            }
            .right {
                text-align: right;
                width: 1px;
            }
        </style>

    </head>
    <body ng-controller="MyController"></body>
        <h1>Changelog</h1>
        <p>
            This generated changelog is based on the <a href="{{config.changelogYamlUrl}}">changelog.yaml</a> in the repositories main branch.
            Click here to <a href="?">list all versions</a>.
        </p>
        <div id="content">

            <div ng-repeat="release in changelog | filter : {version: filter.version}" ng-if="release.changes.length > 0" class="{{release.renderClass}}">
                <h3 class="version" id="{{release.version}}">{{release.version}}</h3>
                <p>Release Date: {{release.dateString}}</p>
                <div ng-repeat="change in release.changes" class="change">
                    <h4>{{change.title}}</h4>
                    <p class="categorization">Type: {{change.type}} / Impact: {{change.impact}}</p>
                    <table width="100%">
                    <tr ng-if="change.description"><td colspan="2"><span ng-bind-html="change.descriptionHtml"></span></td></tr>
                    <tr ng-if="change.warning"><td class="cell right">⚠</td><td class="cell"><span ng-bind-html="change.warningHtml"></span></td></tr>
                    <tr ng-if="change.upgradeNotes"><td class="cell right">❕</td><td class="cell"><span ng-bind-html="change.upgradeNotesHtml"></span></td></tr>
                    <tr ng-if="change.deprecations"><td class="cell right">Deprecations:</td><td class="cell"><span ng-bind-html="change.deprecationsHtml"></span></td></tr>
                    </table>
                    <p>
                        <span ng-repeat="prNumber in change.pullRequestNumbers">
                            <span ng-if="$index > 0">, </span>
                            <a href="{{config.repoUrl}}/pull/{{prNumber}}">#{{prNumber}}</a>
                        </span>
                        <span ng-if="change.pullRequestNumber && change.jiraIssueNumber"> | </span>
                        <span ng-repeat="issueNumber in change.jiraIssueNumbers">
                            <span ng-if="$index > 0">, </span>
                            <a href="{{config.jiraUrl}}/browse/{{config.jiraProjectName}}-{{issueNumber}}">{{config.jiraProjectName}}<span ng-if="config.jiraProjectName">-</span>{{issueNumber}}</a>
                        </span>
                    </p>
                </div>
            </div>

        </div>
    </body>
</html>
