<!-- TODO: Adjust the 'TODO_REPO_URL' occurrences with correct values -->
<html>
    <head>
        <!--
            This dynamic HTML page loads the changelog.yaml from the specified repository
            and renders a more readable, formatted HTML version of it. We recommend to push
            this page to the GitHub pages to make it accessible as HTML.

            This page supports direct links to specific versions by appending '#<version>' to the URL.

            This page supports rendering of specific versions by appending query parameter '?version=<version>' to the URL.
        -->

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
        <script>

            const repoUrl = "https://github.com/SAP/stewardci-core";
            //The following URL has to point the the RAW (!) version of the changelog.yaml in the master branch
            const changelogYamlUrl = "https://raw.githubusercontent.com/SAP/stewardci-core/master/changelog.yaml";
            const jiraUrl = "";
            const jiraProjectName = "";
            let changelog;
            let renderVersion; //if set only show this version. Use query param ?version=<version> to set it.

            $(function(){
                $('#yamlLink').attr('href', changelogYamlUrl);
                xmlhttp=new XMLHttpRequest();
                xmlhttp.onreadystatechange = function()
                {
                    const queryString = window.location.search;
                    const urlParams = new URLSearchParams(queryString);
                    renderVersion = urlParams.get("version");

                    if (xmlhttp.readyState==4 && xmlhttp.status==200)
                    {
                        changelog = jsyaml.load(xmlhttp.responseText);
                        renderChangelog(changelog);
                    }
                }
                xmlhttp.open("GET", changelogYamlUrl, true);
                xmlhttp.send();
            });

            function renderChangelog(changelog) {
                for(let i = 0; i < changelog.length; i++) {
                    let release = changelog[i];
                    if( !renderVersion || renderVersion == release.version ) {
                        if(release.changes && release.changes.length > 0) {
                            $("#content").append(renderRelease(release));
                        }
                    }
                }
            }

            function renderRelease(release) {
                let div = document.createElement("div");
                let releaseDateString;
                if(release.version == "NEXT") {
                    div.setAttribute("class", "next");
                    releaseDateString = "soon";
                } else {
                    div.setAttribute("class", "release");
                    releaseDateString = new Date(release.date).toDateString();
                }
                $(div).append("<h3 class='version' id='"+release.version+"'><a href='?version="+release.version+"'>"+release.version+"</a></h3>");
                $(div).append("<p>Release Date: "+releaseDateString+"</p>");
               
                if(release.changes) {
                    for(let i = 0; i < release.changes.length; i++) {
                        let change = release.changes[i];
                        $(div).append(renderChange(change));
                    }
                }
                return div;
            }

            function renderChange(change) {
                let div = document.createElement("div");
                div.setAttribute("class", "change");
                $(div).append("<h4>"+change.title+"</h4>");
                $(div).append("<p class='categorization'>Type: "+change.type+" / Impact: "+change.impact+"</p>");
                $(div).append(markdown2Html("Description: "+change.description));
                if(change.warning) $(div).append(markdown2Html("⚠ "+change.warning));
                if(change.upgradeNotes) $(div).append(markdown2Html("❕ "+change.upgradeNotes));
                if(change.deprecations) $(div).append(markdown2Html("Deprecations: "+change.deprecations));
                let html = "<p class='categorization'>";
                if(change.pullRequestNumber) {
                    let pullRequests = (typeof change.pullRequestNumber == "number") ? [change.pullRequestNumber] : change.pullRequestNumber;
                    html = renderPullRequests(html, pullRequests);
                }
                if(change.jiraIssueNumber) {
                    if(change.pullRequestNumber) html += " | ";
                    let jiraIssues = (typeof change.jiraIssueNumber == "number") ? [change.jiraIssueNumber] : change.jiraIssueNumber;
                    html = renderJiraIssues(html, jiraIssues);
                }
                html += "</p>";
                $(div).append(html);
                return div;
            }

            function renderPullRequests(html, pullRequests) {
                pullRequests.forEach(function(prNumber, index) {
                    if(index > 0) html += ", ";
                    html += "<a href='"+repoUrl+"/pull/"+prNumber+"'>#"+prNumber+"</a>";
                });
                return html;
            }

            function renderJiraIssues(html, jiraIssues) {
                jiraIssues.forEach(function(issueNumber, index) {
                    if(index > 0) html += ", ";
                    if(jiraUrl) {
                        html += "<a href='"+jiraUrl+"/browse/"+jiraProjectName+"-"+issueNumber+"'>"+jiraProjectName+issueNumber+"</a>";
                    } else {
                        html += jiraProjectName+issueNumber;
                    }
                });
                return html;
            }

            function markdown2Html(markdownText) {
                let mdConverter = new showdown.Converter();
                let html = mdConverter.makeHtml(markdownText);
                return html;
            }
        </script>

        <style>
            body {
                font-family: sans-serif;
            }
            .next {
                background-color: palegoldenrod;
                padding: 5px;
                margin-bottom: 10px;
            }
            .release {
                background-color: LightBlue;
                padding: 5px;
                margin-bottom: 10px;
            }
            .change {
                background-color: #eee;
                padding: 5px;
                margin-bottom: 10px;
            }
            .categorization {
                font-size: 0.9em;
                color: royalblue;
            }
            .version a {
                text-decoration: none;
                color: black;
            }
        </style>

    </head>
    <body>
        <h1>Changelog</h1>
        <p>
            This generated changelog is based on the <a id="yamlLink" href="#">changelog.yaml</a> in the repositories main branch.
            Click here to <a href="?">list all versions</a>.
        </p>
        <div id="content"></div>
    </body>
</html>
