<html>
    <head>

        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/3.14.0/js-yaml.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/showdown/1.9.1/showdown.min.js"></script>
        <script>

            const repoUrl = "https://github.com/SAP/stewardci-core"
            //The following URL has to point the the RAW (!) version of the changelog.yaml in the master branch
            const changelogYamlUrl = "https://raw.githubusercontent.com/SAP/stewardci-core/master/changelog.yaml"
            var changelog;
            var renderVersion; //if set only show this version. Use query param ?version=<version> to set it.

            $(function(){
                xmlhttp=new XMLHttpRequest();
                xmlhttp.onreadystatechange = function()
                {
                    const queryString = window.location.search;
                    const urlParams = new URLSearchParams(queryString);
                    renderVersion = urlParams.get("version");

                    if (xmlhttp.readyState==4 && xmlhttp.status==200)
                    {
                        changelog = jsyaml.load(xmlhttp.responseText);
                        renderChangelog(changelog);
                    }
                }
                xmlhttp.open("GET", changelogYamlUrl, true);
                xmlhttp.send();
            });

            function renderChangelog(changelog) {
                for(var i = 0; i < changelog.length; i++) {
                    var release = changelog[i];
                    if( !renderVersion || renderVersion == release.version ) {
                        $("#content").append(renderRelease(release))
                    }
                }
            }

            function renderRelease(release) {
                var div = document.createElement("div");
                var releaseDateString
                if(release.version == "NEXT") {
                    div.setAttribute("class", "next")
                    releaseDateString = "soon"
                } else {
                    div.setAttribute("class", "release")
                    releaseDateString = new Date(release.date).toDateString()
                }
                $(div).append("<h3 id='"+release.version+"'>"+release.version+"</h3>");
                $(div).append("<p>Release Date: "+releaseDateString+"</p>");

                if(release.changes) {
                    for(var i = 0; i < release.changes.length; i++) {
                    var change = release.changes[i];
                    $(div).append(renderChange(change))
                }
                }
                return div;
            }

            function renderChange(change) {
                var div = document.createElement("div");
                div.setAttribute("class", "change")
                $(div).append("<h4>"+change.title+"</h4>");
                $(div).append("<p class='categorization'>Type: "+change.type+" / Impact: "+change.impact+"</p>");
                $(div).append(markdown2Html("Description: "+change.description));
                if(change.warning) $(div).append(markdown2Html("⚠ "+change.warning));
                if(change.upgradeNotes) $(div).append(markdown2Html("❕ "+change.upgradeNotes));
                if(change.deprecations) $(div).append(markdown2Html("Deprecations: "+change.deprecations));
                $(div).append("<p class='categorization'><a href='"+repoUrl+"/pull/"+change.pullRequestNumber+"'>#"+change.pullRequestNumber+"</a></p>");
                return div;
            }

            function markdown2Html(markdownText) {
                var mdConverter = new showdown.Converter();
                var html = mdConverter.makeHtml(markdownText)
                return html
            }
        </script>

        <style>
            body {
                font-family: sans-serif;
            }
            .next {
                background-color: palegoldenrod;
                padding: 5px;
                margin-bottom: 10px;
            }
            .release {
                background-color: LightBlue;
                padding: 5px;
                margin-bottom: 10px;
            }
            .change {
                background-color: #eee;
                padding: 5px;
                margin-bottom: 10px;
            }
            .categorization {
                font-size: 0.9em;
                color: royalblue;
            }
        </style>

    </head>
    <body>
        <h1>Changelog</h1>
        <p><i>This generated changelog is based on the <a href="https://github.com/SAP/stewardci-core/blob/master/changelog.yaml">changelog.yaml</a> in the repositories main branch.</i></p>
        <div id="content"></div>
    </body>
</html>
